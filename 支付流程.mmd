flowchart TD
    Start([ç”¨æˆ·å‘èµ·æ”¯ä»˜]) --> CheckSource{æ”¯ä»˜æ¥æº}
    
    %% ç«‹å³è´­ä¹°æµç¨‹
    CheckSource -->|ç«‹å³è´­ä¹° buyNow| BuyNow[åˆ›å»ºè®¢å•å¯¹è±¡<br/>è®¡ç®—å°è®¡å’Œé…é€è´¹]
    BuyNow --> PaymentScreen1[è·³è½¬åˆ°æ”¯ä»˜é¡µé¢<br/>PaymentScreen]
    
    %% è´­ç‰©è½¦ç»“ç®—æµç¨‹
    CheckSource -->|è´­ç‰©è½¦ç»“ç®— cart| Cart[åˆ›å»ºè®¢å•å¯¹è±¡<br/>è®¡ç®—å°è®¡å’Œé…é€è´¹]
    Cart --> PaymentScreen2[è·³è½¬åˆ°æ”¯ä»˜é¡µé¢<br/>PaymentScreen]
    
    %% è®¢å•ç«‹å³æ”¯ä»˜æµç¨‹
    CheckSource -->|è®¢å•ç«‹å³æ”¯ä»˜ orderPay| DirectPay[ç›´æ¥å¤„ç†æ”¯ä»˜<br/>ä¸è·³è½¬é¡µé¢]
    
    %% æ”¯ä»˜é¡µé¢å¤„ç†æµç¨‹
    PaymentScreen1 --> FillInfo[å¡«å†™è®¢å•ä¿¡æ¯<br/>- é€‰æ‹©è®¢å•ç±»å‹<br/>- é€‰æ‹©é…é€åœ°å€<br/>- å¡«å†™å¤‡æ³¨]
    PaymentScreen2 --> FillInfo
    
    FillInfo --> Validate{éªŒè¯è¡¨å•}
    Validate -->|éªŒè¯å¤±è´¥| ShowError[æ˜¾ç¤ºé”™è¯¯æç¤º]
    ShowError --> FillInfo
    
    Validate -->|éªŒè¯æˆåŠŸ| CheckEnv{æ£€æŸ¥ç¯å¢ƒ}
    CheckEnv -->|éFChatç¯å¢ƒ| ShowDialog[æ˜¾ç¤ºFChatæ”¯ä»˜æç¤º]
    ShowDialog --> End1([ç»“æŸ])
    
    CheckEnv -->|FChatç¯å¢ƒ| PrepareOrder[å‡†å¤‡è®¢å•æ•°æ®<br/>- æ›´æ–°è®¢å•ç±»å‹<br/>- æ›´æ–°é…é€åœ°å€<br/>- æ›´æ–°é…é€è´¹<br/>- æ›´æ–°æ€»é‡‘é¢]
    
    %% ç›´æ¥æ”¯ä»˜æµç¨‹
    DirectPay --> CreatePaymentReq1[åˆ›å»ºæ”¯ä»˜è¯·æ±‚<br/>PaymentRequest]
    
    %% æ”¯ä»˜é¡µé¢æ”¯ä»˜æµç¨‹
    PrepareOrder --> CreatePaymentReq2[åˆ›å»ºæ”¯ä»˜è¯·æ±‚<br/>PaymentRequest]
    
    CreatePaymentReq1 --> CreateAppPayment[åˆ›å»ºAppæ”¯ä»˜<br/>_createAppPayment]
    CreatePaymentReq2 --> CreateAppPayment
    
    CreateAppPayment --> CreatePayObj[åˆ›å»ºFChatæ”¯ä»˜å¯¹è±¡<br/>PayObj<br/>- è®¢å•ä¿¡æ¯<br/>- æ”¯ä»˜é‡‘é¢<br/>- æ”¯ä»˜æè¿°]
    
    CreatePayObj --> GeneratePaymentId[ç”Ÿæˆæ”¯ä»˜ID<br/>payObj.getPayid]
    GeneratePaymentId --> SaveOrderToApp[ä¿å­˜è®¢å•åˆ°App<br/>OrderMonitorService.appSave]
    
    SaveOrderToApp --> StartPayment[ç¡®è®¤æ”¯ä»˜<br/>payObj.pay]
    
    StartPayment --> StartVerification[å¯åŠ¨æ”¯ä»˜éªŒè¯<br/>æ¯20ç§’éªŒè¯ä¸€æ¬¡<br/>æœ€å¤š10åˆ†é’Ÿè¶…æ—¶]
    
    %% æœåŠ¡å™¨æ¨é€æ¶ˆæ¯ï¼ˆå‘èµ·æ”¯ä»˜æ—¶ï¼‰
    StartPayment -.->|æœåŠ¡å™¨pushè®¢å•æ¶ˆæ¯| ServerPush[æœåŠ¡å™¨æ¨é€è®¢å•æ¶ˆæ¯<br/>ç»™æœåŠ¡å·ç”¨æˆ·<br/>ğŸ“¤ æ¨é€æ—¶æœº1: å‘èµ·æ”¯ä»˜æ—¶]
    
    ServerPush --> ParseServerPush[æœåŠ¡å·è§£æpushæ¶ˆæ¯<br/>UnifiedOrderService.parseOrderPushData<br/>- æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜<br/>- ç”Ÿæˆè®¢å•å·<br/>- ä¿å­˜è®¢å•æ–‡ä»¶<br/>- æ¨é€æ‰“å°è®¢å•]
    
    StartVerification --> WaitCallback[ç­‰å¾…æ”¯ä»˜å›è°ƒ<br/>â³ å¼‚æ­¥ç­‰å¾…<br/>ä½¿ç”¨Completerç­‰å¾…ç»“æœ]
    StartVerification -->|å®šæ—¶éªŒè¯| VerifyPayment[å®šæ—¶éªŒè¯æ”¯ä»˜çŠ¶æ€<br/>æ¯20ç§’éªŒè¯ä¸€æ¬¡<br/>WebPayUtil.isverifyPay]
    
    VerifyPayment --> VerifyResult{éªŒè¯ç»“æœ}
    VerifyResult -->|æ”¯ä»˜æˆåŠŸ| HandleVerifySuccess[å¤„ç†éªŒè¯æˆåŠŸ<br/>- åˆ›å»ºè®¢å•<br/>- è°ƒç”¨æ”¯ä»˜æˆåŠŸå›è°ƒ<br/>ğŸ“¤ æ¨é€è®¢å•æ¶ˆæ¯<br/>OrderPushType.newOrder]
    VerifyResult -->|æœªæ”¯ä»˜| ContinueVerify[ç»§ç»­ç­‰å¾…éªŒè¯<br/>æœ€å¤š10åˆ†é’Ÿ]
    ContinueVerify --> VerifyPayment
    
    WaitCallback --> ReceiveCallback{æ”¶åˆ°æ”¯ä»˜å›è°ƒ}
    
    ReceiveCallback -->|æ”¯ä»˜æˆåŠŸ| ParseSuccess[è§£ææ”¯ä»˜ç»“æœ<br/>status = true<br/>è·å–payid]
    ReceiveCallback -->|æ”¯ä»˜å¤±è´¥| ParseFailure[è§£æå¤±è´¥åŸå› <br/>status = å¤±è´¥åŸå› å­—ç¬¦ä¸²]
    ReceiveCallback -->|æ”¯ä»˜å–æ¶ˆ| ParseCancel[è§£æå–æ¶ˆåŸå› <br/>status = cancelled]
    ReceiveCallback -->|æ”¯ä»˜è¶…æ—¶| ParseTimeout[æ”¯ä»˜è¶…æ—¶<br/>5åˆ†é’Ÿæœªæ”¶åˆ°å›è°ƒ]
    
    ParseSuccess --> CleanupSuccess[æ¸…ç†ç¼“å­˜<br/>åœæ­¢éªŒè¯<br/>åˆ é™¤Appä¸­çš„è®¢å•]
    ParseFailure --> CleanupFailure[æ¸…ç†ç¼“å­˜<br/>åœæ­¢éªŒè¯<br/>åˆ é™¤Appä¸­çš„è®¢å•]
    ParseCancel --> CleanupCancel[æ¸…ç†ç¼“å­˜<br/>åœæ­¢éªŒè¯<br/>åˆ é™¤Appä¸­çš„è®¢å•]
    ParseTimeout --> CleanupTimeout[æ¸…ç†ç¼“å­˜<br/>åœæ­¢éªŒè¯]
    
    CleanupSuccess --> UpdateOrder[æ›´æ–°è®¢å•çŠ¶æ€<br/>- æ›´æ–°è®¢å•åˆ°æœåŠ¡]
    UpdateOrder --> ShowSuccessDialog[æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸå¼¹çª—]
    ShowSuccessDialog --> NavigateToOrders[è·³è½¬åˆ°è®¢å•é¡µé¢<br/>NavigationService.switchToOrdersPage]
    
    NavigateToOrders --> CheckOrderFile[æ£€æŸ¥ä¸´æ—¶è®¢å•æ–‡ä»¶<br/>_checkAndCreateOrderIfNeeded<br/>æœ€å¤šæ£€æŸ¥3æ¬¡ï¼Œæ¯æ¬¡é—´éš”2ç§’]
    
    CheckOrderFile --> FileExists{æ–‡ä»¶æ˜¯å¦å­˜åœ¨}
    FileExists -->|å­˜åœ¨| ReadOrder[è¯»å–è®¢å•å¹¶æ›´æ–°<br/>Order.readOrderWithOrderId]
    FileExists -->|ä¸å­˜åœ¨| CreateOrder[åˆ›å»ºè®¢å•<br/>- çŠ¶æ€æ”¹ä¸ºå·²æ”¯ä»˜<br/>- è·å–è®¢å•å·<br/>- ä¿å­˜è®¢å•æ–‡ä»¶<br/>ğŸ“¤ æ¨é€è®¢å•æ¶ˆæ¯<br/>OrderPushType.newOrder<br/>ğŸ“¤ æ¨é€æ—¶æœº2: æ”¯ä»˜æˆåŠŸååˆ›å»ºè®¢å•]
    
    ReadOrder --> UpdateOrderMonitor[æ›´æ–°OrderMonitorService]
    CreateOrder --> UpdateOrderMonitor
    
    UpdateOrderMonitor --> HandlePaymentSuccess[å¤„ç†æ”¯ä»˜æˆåŠŸå›è°ƒ<br/>PaymentCallbackService.handlePaymentSuccess<br/>- æ¸…ç©ºè´­ç‰©è½¦<br/>- ç»™äºˆä¸‹å•å¥–åŠ±ç»éªŒ]
    
    HandlePaymentSuccess --> End2([æ”¯ä»˜å®Œæˆ])
    
    HandleVerifySuccess --> End2
    
    %% Pushæ¶ˆæ¯å¤„ç†æµç¨‹ï¼ˆå¼‚æ­¥ç›‘å¬ï¼‰
    CreateOrder -.->|è§¦å‘pushæ¶ˆæ¯| ParsePushMessage[è§£æpushæ¶ˆæ¯<br/>FChatBridge.onMessageç›‘å¬<br/>UnifiedOrderService.parseOrderPushData<br/>â³ å¼‚æ­¥ç­‰å¾…]
    HandleVerifySuccess -.->|è§¦å‘pushæ¶ˆæ¯| ParsePushMessage
    
    ParsePushMessage --> HandlePushData{å¤„ç†pushæ•°æ®}
    HandlePushData -->|è®¢å•æ•°æ®| UpdateOrderFromPush[æ›´æ–°è®¢å•<br/>- æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜<br/>- ç”Ÿæˆè®¢å•å· â³ å¼‚æ­¥ç­‰å¾…<br/>- æ›´æ–°è®¢å•åˆ°æœåŠ¡ â³ å¼‚æ­¥ç­‰å¾…<br/>- æ›´æ–°è®¢å•æ–‡ä»¶ â³ å¼‚æ­¥ç­‰å¾…]
    HandlePushData -->|è®¢å•æ¨é€æ•°æ®| ProcessOrderPush[å¤„ç†è®¢å•æ¨é€<br/>- æ ¹æ®æ¨é€ç±»å‹æ“ä½œ<br/>- æ›´æ–°è®¢å•çŠ¶æ€<br/>- åˆ·æ–°è®¢å•åˆ—è¡¨]
    
    UpdateOrderFromPush --> CheckPrint{è®¢å•æ˜¯å¦å·²æ‰“å°}
    CheckPrint -->|æœªæ‰“å°| PushPrintOrder[æ¨é€æ‰“å°è®¢å•]
    CheckPrint -->|å·²æ‰“å°| End4([Pushæ¶ˆæ¯å¤„ç†å®Œæˆ])
    
    ProcessOrderPush --> End4
    
    CleanupFailure --> ShowFailureDialog[æ˜¾ç¤ºæ”¯ä»˜å¤±è´¥å¼¹çª—]
    CleanupCancel --> ShowCancelDialog[æ˜¾ç¤ºæ”¯ä»˜å–æ¶ˆå¼¹çª—]
    CleanupTimeout --> ShowTimeoutDialog[æ˜¾ç¤ºæ”¯ä»˜è¶…æ—¶å¼¹çª—]
    
    ShowFailureDialog --> DeleteTempOrder[åˆ é™¤ä¸´æ—¶è®¢å•æ–‡ä»¶<br/>â³ å¼‚æ­¥ç­‰å¾…]
    ShowCancelDialog --> DeleteTempOrder
    ShowTimeoutDialog --> DeleteTempOrder
    
    DeleteTempOrder --> End3([æ”¯ä»˜å¤±è´¥/å–æ¶ˆ/è¶…æ—¶])
    
    style Start fill:#e1f5ff
    style End2 fill:#c8e6c9
    style End4 fill:#c8e6c9
    style End1 fill:#ffccbc
    style End3 fill:#ffccbc
    style ParseSuccess fill:#c8e6c9
    style ParseFailure fill:#ffcdd2
    style ParseCancel fill:#ffe0b2
    style ParseTimeout fill:#ffe0b2
    style WaitCallback fill:#fff9c4
    style UpdateOrder fill:#fff9c4
    style ParsePushMessage fill:#fff9c4
    style UpdateOrderFromPush fill:#fff9c4
    style HandlePaymentSuccess fill:#fff9c4
    style DeleteTempOrder fill:#fff9c4
    style ServerPush fill:#ffeb3b,stroke:#f57f17,stroke-width:3px
    style ParseServerPush fill:#ffeb3b,stroke:#f57f17,stroke-width:3px
    style CreateOrder fill:#4caf50,stroke:#2e7d32,stroke-width:3px
    style HandleVerifySuccess fill:#4caf50,stroke:#2e7d32,stroke-width:3px
